name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64
    
    - name: Build PedalBoard VST3
      run: |
        cmake --build build --target OpenGuitar_PedalBoard_VST3 --config Release
    
    - name: Build Compressor VST3
      run: |
        cmake --build build --target OpenGuitar_Compressor_VST3 --config Release
      
    - name: Build Fuzz VST3
      run: |
        cmake --build build --target OpenGuitar_Fuzz_VST3 --config Release
      
    - name: Build Reverb VST3
      run: |
        cmake --build build --target OpenGuitar_Reverb_VST3 --config Release
    
    - name: Package artifacts
      shell: pwsh
      run: |
        # Create release directory
        New-Item -ItemType Directory -Force -Path release
        
        # Copy PedalBoard VST3
        if (Test-Path "build\OpenGuitar_PedalBoard_artefacts\Release\VST3\OpenGuitar Pedal Board.vst3") {
          Copy-Item -Path "build\OpenGuitar_PedalBoard_artefacts\Release\VST3\OpenGuitar Pedal Board.vst3" -Destination "release\" -Recurse
        }
        
        # Copy individual effects
        if (Test-Path "build\OpenGuitar_Compressor_artefacts\Release\VST3\OpenGuitar Compressor.vst3") {
          Copy-Item -Path "build\OpenGuitar_Compressor_artefacts\Release\VST3\OpenGuitar Compressor.vst3" -Destination "release\" -Recurse
        }
        if (Test-Path "build\OpenGuitar_Fuzz_artefacts\Release\VST3\OpenGuitar Fuzz.vst3") {
          Copy-Item -Path "build\OpenGuitar_Fuzz_artefacts\Release\VST3\OpenGuitar Fuzz.vst3" -Destination "release\" -Recurse
        }
        if (Test-Path "build\OpenGuitar_Reverb_artefacts\Release\VST3\OpenGuitar Reverb.vst3") {
          Copy-Item -Path "build\OpenGuitar_Reverb_artefacts\Release\VST3\OpenGuitar Reverb.vst3" -Destination "release\" -Recurse
        }
        
        # Create zip archive
        Compress-Archive -Path "release\*" -DestinationPath "OpenGuitar-VST3-Windows-x64.zip"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenGuitar-VST3-Windows
        path: OpenGuitar-VST3-Windows-x64.zip
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: OpenGuitar-VST3-Windows-x64.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Development Release
      if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: Development Build
        tag_name: dev-latest
        files: OpenGuitar-VST3-Windows-x64.zip
        draft: false
        prerelease: true
        generate_release_notes: false
        body: |
          Automated development build from main branch.
          
          **Warning:** This is an unstable development build. Use at your own risk.
          
          Built from commit: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
